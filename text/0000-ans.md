ARA Network Secrets (ANS)
=========================

---
Request For Comments: 0000
---
Author(s): Joseph Werle, Prashanth Balasubramani
---
Category: Security
---
Date: June, 2018
---

## 0. Abstract

_**ARA Network Secrets**_ describes an asymmetric secret storage for
network authentication, integrity, capability, and discovery protocols.

## 1.Status

This RFC is under _active development and consideration_.

## 2. Introduction

_**ARA Network Secrets**_ is an asymmetric secret storage [1] for storing
public and secret network keys used for peer discovery and capability based
handshakes [2]. Alice (client) can express capability to Bob (remote) through a
_key-hashed message authentication code_ (HMAC) [9] using a network key she
got from Bob's _public_ network secrets.

Network secrets come in two variants: _public_ and _secret_. They are
asymmetrical and represent a _public_ and _secret_ version of Bob's
keys.

_**Public**_ network secrets are offered publicly by Bob accompanied with a
_shared secret key_ [8] that encrypts a _discovery key_, _network key_,
and _public key_.

_**Secret**_ network secrets can only be decrypted by the party who generated
them as they are encrypted by the secret key they encapsulate. _Secret_
network secrets _should never_ be distributed.

## 3. Background & Motivation

In a decentralized network of peers performing some service, entities
wishing to make use of them need to be able to discover, connect, and
authenticate with them. Peers need to be able to prove capability
and authenticate when connecting.

In this RFC we present an approach to secret storage [1] that enables a
capability handshakes [2] in networking protocols between two peers
wishing to authenticate and communicate with each other.

## 4. Network Secrets

This section outlines parameters and a procedure for creating _network
secrets_ as it relates to this RFC.

### 4.1 Terminology

The rest of the sections that follow make use of abbreviated forms of the
following terminology outlined in this section.

* _**PNRG**_ - _Pseudo-Random Number Generator_ [3] [4]
* _**PKX**_ - Public Key Magic Byte
* _**SKX**_ - Secret Key Magic Byte
* _**A**_ - _Alice_ (Client Peer)
* _**B**_ - _Bob_ (Remote Peer)
* _**D**_ - _Discovery Key_ (Generated by _Bob_)
* _**K**_ - _Network Key_ (Generated by _Bob_)
* _**S**_ - _Shared Secret Key_ (Generated by _Bob_)
* _**Z**_ - Combined Network Secrets (Public + Secret)

### 4.x Notation

The rest of the sections that follow makes use of the following notation.

* `:=` denotes _assignment_
* `=` denotes _equality_
* `≠` denotes _inequality_
* `|` denotes _concatenation_
* `≈` denotes _approximately equal to_
* `⇐` denotes _response_
* `⇒` denotes _request_
* `?` denotes _unknown_
* `·` denotes _derived from_ (`a · b`)
* `A` denotes _constant Alice_
* `B` denotes _constant Bob_
* `D` denotes _constant Discovery_
* `K` denotes _constant Network_
* `S` denotes _constant Secret_
* `a` denotes _ephemeral Alice_
* `b` denotes _ephemeral Bob_
* `s` denotes _intermediate Secret_
* `A`<sub>public</sub> or `A`<sub>p</sub> denotes _constant public key for Alice_
* `A`<sub>secret</sub> or `A`<sub>s</sub> denotes _constant secret key for Alice_
* `B`<sub>public</sub> or `B`<sub>p</sub> denotes _constant public key for Bob_
* `B`<sub>secret</sub> or `B`<sub>s</sub> denotes _constant secret key for Bob_
* `K`<sub>public</sub> or `K`<sub>p</sub> denotes _constant public key for Network_
* `K`<sub>secret</sub> or `K`<sub>s</sub> denotes _constant secret key for Network_
* `a`<sub>public</sub> or `a`<sub>p</sub> denotes _ephemeral public key for Alice_
* `a`<sub>secret</sub> or `a`<sub>s</sub> denotes _ephemeral secret key for Alice_
* `b`<sub>public</sub> or `b`<sub>p</sub> denotes _ephemeral public key for Bob_
* `b`<sub>secret</sub> or `b`<sub>s</sub> denotes _ephemeral secret key for Bob_

### 4.x Shared Secret Key

The shared secret key _S_ [8] is a 16 byte value determined by _B_. It
does not have to be unique, but should be secure and easy to transmit or
delegate to interested parties.

_S_ is used to compute the ephemeral intermediate value _s_, which is a
_seed_ for computing a _Curve25519_ [6] network key pair _K_. To compute _s_,
compute the 32 byte BLAKE2b [7] hash of _S_.

_s = BLAKE2b-256(S)_

The value of _S_ is shared between _B_ and _A_. It is determined by _B_,
and given to _A_ by some form of delegation [5].

### 4.x Network Key Pair

The network key pair _K_ is computed from the ephemeral intermediate
value _s_ derived from _S_. The key pair is a _Curve25519_ [6] key pair.

_K = Curve25519(BLAKE2b-256(S))_

Where _K<sub>public</sub>_ (_K<sub>p</sub>_) is the 32 byte public key and
_K<sub>secret</sub>_ (_K<sub>s</sub>_) is the 32 byte secret key.

### 4.x Discovery Key

The discovery key _D_ is a unique 256-bit value used for peer discovery in
networks. This value is a 32 byte BLAKE2b hash of _K<sub>secret</sub>_.

_D = BLAKE2b-256(K<sub>secret</sub>)_

### 4.x Bob's Keys

Bob's keys are an asymmetrical _ed25519_ key pair _B_. They represent
the authenticity of Bob. Bob's public key, among others, is made public
and stored in the **public** _network secrets_ secret storage. Alice can use
_B<sub>public</sub>_ to authenticate with Bob. Bob's secret key, along
with _K<sub>secret</sub>_ is stored in a **secret** _network secrets_ secret
storage encrypted by _B<sub>secret</sub>_.

### 4.x Alice's Keys

Alice's keys are an asymmetrical _ed25519_ key pair _A_. They represent
the authenticity of Alice. Alice can use her public key _A<sub>public</sub>_
and secret key _A<sub>secret</sub>_ with _K<sub>public</sub>_ and
_B<sub>public</sub>_ to authenticate with Bob. Alice acquires
_B<sub>public</sub>_ and _K<sub>public</sub>_ from Bob's **public**
_network secrets_.

### 4.x Delegation

TODO

### 4.x Binary Format

This section outlines the packed binary format for network secrets.

#### Magic Bytes

A magic byte is appended to the packed binary to indicate the type of
keys that will follow.

![](http://latex.codecogs.com/gif.latex?PKX%20%3A%3D%2070_%7Bhex%7D)

_PKX_ is a single byte represented by the hexadecimal value `0x70` to
indicate that the keys in the secret storage are public keys.

![](http://latex.codecogs.com/gif.latex?SKX%20%3A%3D%2073_%7Bhex%7D)

_SKX_ is a single byte represented by the hexadecimal value `0x73` to
indicate that the keys in the secret storage are secret keys.

#### Layout

Network secrets are packed binary represented by a header and a body
containing a set of public or secret keys.

```
> ~~~~~~~~~~ HEADER ~~~~~~~~ < > ~~~~~~~~~~~~~ BODY ~~~~~~~~~~~ <
| 1 byte  | 32 bytes          | [32|64] bytes   | [32|64] bytes |
| ------- | ----------------- | --------------- | ------------- |
| PKX|SKX | Discovery Key (D) | Network Key (K) | Bob's Key (B) |
| ------- | ----------------- | --------------- | ------------- |
```

![](http://latex.codecogs.com/gif.latex?%5Cnewline%20public%28D%2C%20K%2C%20B%29%20%3D%20%5Cleft%20%5C%7B%2070_%7Bhex%7D%20&plus;%20D%20&plus;%20K_%7Bpublic%7D%20&plus;%20B_%7Bpublic%7D%20%5Cright%20%5C%7D%20%5Cnewline%20secret%28D%2C%20K%2C%20B%29%20%3D%20%5Cleft%20%5C%7B%2073_%7Bhex%7D%20&plus;%20D%20&plus;%20K_%7Bsecret%7D%20&plus;%20B_%7Bsecret%7D%20%5Cright%20%5C%7D)


##### Header

The header of network secrets is always `1 + 32` bytes. It contains a
magic byte and the discovery key _D_ generated by Bob. The magic byte
indicates the size of the keys that follow right after the header. Using
this information you can compute the _stride_ when enumerating the keys
in the network secrets.

![](http://latex.codecogs.com/gif.latex?stride%28x%29%20%3D%20%5Cbegin%7Bcases%7D%2032%20%26%20%5Ctext%7B%20if%20%7D%20x%3D%2070_%7Bhex%7D%20%5C%5C%2064%20%26%20%5Ctext%7B%20if%20%7D%20x%3D%2073_%7Bhex%7D%7D%20%5C%5C%200%20%26%20%5Ctext%7B%20otherwise%20%7D%20%5Cend%7Bcases%7D)

##### Body

The body of the network secrets is either a series of public or secret
keys. The magic byte indicates what type of keys will
be present after the header. Using the _magic byte_ as input to _stride(x)_ we
can determine the stride when reading keys.

#### Packing

TODO

#### Unpacking

TODO

### 4.x Secrets Generation

Bob's asymmetric network secrets can be generated from _B_ and _S_ by
following the procedure outlined in this section.

1. Compute _ephemeral_ _BLAKE2b_ shared secret key _s_ from the _constant_
   shared secret key _S_.
2. Compute _constant_ _Curve25519_ network key pair _K_ based on previously
   computed _ephemeral_ _s_ seed value.
3. Compute _constant_ _BLAKE2b_ discovery key _D_ from
   _constant_ secret key _K<sub>secret</sub>_.
4. Pack _PKX_, _D_, _K<sub>public</sub>_, and _B<sub>public</sub>_ into
   _Z<sub>public</sub>_
5. Pack _SKX_, _D_, _K<sub>secret</sub>_, and _B<sub>secret</sub>_ into
   _Z<sub>secret</sub>_
6. Concatenate and return _Z<sub>public</sub>_ and _Z<sub>secret</sub>_

```js
function GenerateSecrets(B, S) {
  s = BLAKE2b256(S)
  K = Curve25519(s)
  D = BLAKE2b256(Ks)
  return Concat(Pack(PKX, D, Kp, Bp), Pack(SKX, D, Ks, Bs))
}
```

## 5. Real World Example

TODO

## 6. Drawbacks

TODO

## 7. Alternatives

TODO

## 8. Adoption Strategy

TODO

## 9. Unresolved Questions

TODO

## 10 Security Considerations

TODO

## 11. References

* [1] - *https://github.com/arablocks/rfcs/tree/master/text/0001-ass.md*
* [2] - *http://dominictarr.github.io/secret-handshake-paper/shs.pdf*
* [3] - *https://en.wikipedia.org/wiki/Pseudorandom_number_generator*
* [4] - *https://en.wikipedia.org/wiki/Pseudorandom_generator*
* [5] - *https://en.wikipedia.org/wiki/Delegation*
* [6] - *https://cr.yp.to/ecdh/curve25519-20060209.pdf*
* [7] - *https://blake2.net/blake2.pdf*
* [8] - *https://en.wikipedia.org/wiki/Shared_secret*
* [9] - *https://tools.ietf.org/html/rfc2104*
